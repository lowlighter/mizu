<section>
  <p class="flash attention">
    Playground is still being developed.
  </p>
</section>
<div class="playground demo" data-color-scheme="dark">
  <div class="mockups">
    <div class="mockup browser">
      <div class="tabs">
        <img class="app-icon" src="https://lecoq.io/cdn/logos/browsers.svg" />
        <div class="tab active">
          Playground
          <div class="before"></div>
          <div class="after"></div>
        </div>
        <div class="grow"></div>
        <svg class="mr-1" xmlns="http://www.w3.org/2000/svg" width="54" height="14" viewBox="0 0 54 14">
          <g fill="none" fill-rule="evenodd" transform="translate(1 1)">
            <circle cx="6" cy="6" r="6.5" fill="var(--danger)"></circle>
            <circle cx="26" cy="6" r="6.5" fill="var(--attention)"></circle>
            <circle cx="46" cy="6" r="6.5" fill="var(--success)"></circle>
          </g>
        </svg>
      </div>
      <div class="urlbar">
        <i class="fake" %http="https://lecoq.io/cdn/octicons/arrow-left-24.svg" %response.swap></i>
        <i id="render" %http="https://lecoq.io/cdn/octicons/sync-24.svg" %response.swap></i>
        <input class="fake" type="text" value="https://mizu.test/playground" />
        <i class="fake hide-small" %http="https://lecoq.io/cdn/octicons/star-24.svg" %response.swap></i>
        <i class="fake hide-small" %http="https://lecoq.io/cdn/octicons/three-bars-24.svg" %response.swap></i>
      </div>
      <div class="app-view">
        <div class="browser-view">
          <iframe></iframe>
        </div>
        <div class="browser-inspector">
          <div class="browser-inspector-bar">
            <i class="fake" %http="https://lecoq.io/cdn/octicons/link-external-16.svg" %response.swap></i>
            <i class="fake hide-small" %http="https://lecoq.io/cdn/octicons/device-mobile-16.svg" %response.swap></i>
            <i class="fake hide-small" %http="https://lecoq.io/cdn/octicons/sidebar-collapse-16.svg" %response.swap></i>
            <div class="active">
              <i %http="https://lecoq.io/cdn/octicons/code-16.svg" %response.swap></i>
              <small>Elements</small>
            </div>
            <i class="fake" %http="https://lecoq.io/cdn/octicons/terminal-16.svg" %response.swap></i>
            <i class="fake" %http="https://lecoq.io/cdn/octicons/bug-16.svg" %response.swap></i>
            <i class="fake" %http="https://lecoq.io/cdn/octicons/broadcast-16.svg" %response.swap></i>
            <i class="fake" %http="https://lecoq.io/cdn/octicons/meter-16.svg" %response.swap></i>
            <i class="fake" %http="https://lecoq.io/cdn/octicons/cpu-16.svg" %response.swap></i>
            <i class="fake" %http="https://lecoq.io/cdn/octicons/browser-16.svg" %response.swap></i>
          </div>
          <div class="browser-inspector-content">
            <div class="wrapper">
              <div class="editor">
                <textarea %http="/html/mizu/examples/playground/example.html" %response.text></textarea>
                <div class="highlight"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script src="/highlight.js"></script>
<script>
  window.addEventListener("load", function () {
    // Setup elements
    const playground = document.querySelector(".playground")
    const editor = document.querySelector(".editor")
    const textarea = editor.querySelector("textarea")
    const highlight = editor.querySelector(".highlight")
    const button = document.querySelector("#render")
    const iframe = document.querySelector("iframe")

    // Setup code editor
    function coloration(value) {
      highlight.innerHTML = hljs.highlight(value, { language: "xml" }).value
    }
    textarea.addEventListener("input", () => coloration(textarea.value))
    textarea.addEventListener("input", () => render())
    textarea.addEventListener("scroll", function () {
      highlight.scrollTop = this.scrollTop
      highlight.scrollLeft = this.scrollLeft
    })
    coloration(textarea.value)

    // Setup renderer
    let timeout = NaN
    function render() {
      clearTimeout(timeout)
      timeout = setTimeout(() => button.dispatchEvent(new MouseEvent("click")), 2000)
    }
    button.addEventListener("click", async function () {
      if (playground.classList.contains("pending")) {
        return
      }
      let resolve = null, reject = null
      const promise = new Promise((ok, ko) => {
        resolve = ok
        reject = ko
      })
      try {
        playground.classList.add("pending")
        const frame = iframe.contentDocument
        iframe.onload = resolve
        iframe.onerror = reject
        frame.open()
        frame.write(`
  <!DOCTYPE html>
  <html>
    <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="stylesheet" href="/matcha.css">
    </head>
    <body *mizu class="pt-1">
      ${textarea.value}
      <script src="/client.js" defer><\/script>
    </body>
  </html>`.trim())
        frame.close()

        await promise
      } finally {
        playground.classList.remove("pending")
      }
    })
    render()
  })
</script>
